{% extends 'base.html' %}

{% block content %}
<div class="container py-5 text-center">
    <h2 class="mb-4">Registro de Ponto</h2>
    
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow">
                <div class="card-body">
                    <div id="reader" style="width: 100%;"></div>
                    <div id="result" class="mt-3 alert alert-secondary" style="display: none;"></div>
                </div>
            </div>
            <p class="mt-3 text-muted">Aproxime o QR Code do Crachá na câmera</p>
        </div>
    </div>
</div>

<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<script>
    let isScanning = true;

    function onScanSuccess(decodedText, decodedResult) {
        if (!isScanning) return; // Evita múltiplas leituras seguidas

        isScanning = false;
        document.getElementById('result').style.display = 'block';
        document.getElementById('result').className = 'alert alert-info';
        document.getElementById('result').innerText = "Processando...";

        // Envia para o Backend
        fetch("{% url 'registrar_ponto_api' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({ qr_content: decodedText })
        })
        .then(response => response.json())
        .then(data => {
            const resDiv = document.getElementById('result');
            resDiv.innerText = data.message;
            
            if(data.status === 'success') {
                resDiv.className = 'alert alert-success fw-bold';
                // Toca um som de sucesso (opcional)
                let audio = new Audio('https://actions.google.com/sounds/v1/cartoon/cartoon_boing.ogg');
                audio.play();
            } else if (data.status === 'warning') {
                resDiv.className = 'alert alert-warning';
            } else {
                resDiv.className = 'alert alert-danger';
            }

            // Reativa o scanner após 3 segundos
            setTimeout(() => {
                isScanning = true;
                resDiv.style.display = 'none';
            }, 3000);
        })
        .catch(error => {
            console.error('Error:', error);
            isScanning = true;
        });
    }

    let html5QrcodeScanner = new Html5QrcodeScanner(
        "reader", { fps: 10, qrbox: 250 });
    html5QrcodeScanner.render(onScanSuccess);
</script>
{% endblock %}