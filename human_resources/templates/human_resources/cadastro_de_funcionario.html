{% extends 'base.html' %}
{% load static %}

{% block title %}Gestão de Colaboradores | RH{% endblock %}

{% block content %}
<div class="container py-5">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="page-title mb-0">Gestão de Colaboradores</h2>
        <a href="{% url 'pessoal' %}" class="btn btn-outline-secondary btn-sm rounded-pill">
            <i class="bi bi-arrow-left me-1"></i> Voltar
        </a>
    </div>

    <div class="card border-0 shadow-sm rounded-4 mb-5">
        <div class="card-body p-4" style="background-color: #f8f9fa;">
            <h5 class="text-primary fw-bold mb-3"><i class="bi bi-search me-2"></i>Consultar Funcionário</h5>
            
            <form method="get" class="row g-3 align-items-end">
                <div class="col-md-8">
                    <label class="form-label fw-bold text-muted">Buscar por Nome Completo ou CPF</label>
                    <input type="text" name="termo_busca" class="form-control" 
                           placeholder="Digite o nome ou CPF..." value="{{ termo_busca|default:'' }}">
                </div>
                <div class="col-md-4 d-flex gap-2">
                    <button type="submit" class="btn btn-info text-white fw-bold flex-grow-1">
                        <i class="bi bi-search me-2"></i> Consultar
                    </button>
                    
                    {% if termo_busca or id_editar %}
                    <a href="{% url 'cadastro_funcionarios' %}" class="btn btn-secondary fw-bold">
                        <i class="bi bi-x-lg me-1"></i> Limpar
                    </a>
                    {% endif %}
                </div>
            </form>

            {% if resultados %}
                <div class="table-responsive mt-4">
                    <table class="table table-hover align-middle bg-white rounded shadow-sm">
                        <thead class="table-light">
                            <tr>
                                <th>Nome</th>
                                <th>CPF</th>
                                <th>Cargo</th>
                                <th>Departamento</th>
                                <th>Status</th>
                                <th class="text-end">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for func in resultados %}
                            <tr>
                                <td>{{ func.nome_completo }}</td>
                                <td>{{ func.cpf }}</td>
                                <td>{{ func.cargo }}</td>
                                <td>{{ func.departamento }}</td>
                                <td>
                                    {% if func.desligado %}
                                        <span class="badge bg-danger">Desligado</span>
                                    {% else %}
                                        <span class="badge bg-success">Ativo</span>
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    <a href="?termo_busca={{ termo_busca }}&id_editar={{ func.id }}#formulario_anchor" 
                                       class="btn btn-sm btn-outline-primary fw-bold">
                                        <i class="bi bi-pencil-square me-1"></i> Editar
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% elif termo_busca %}
                <div class="alert alert-warning mt-3">
                    Nenhum funcionário encontrado com "{{ termo_busca }}".
                </div>
            {% endif %}
        </div>
    </div>

    <div id="formulario_anchor"></div>

    <div class="card border-0 shadow-sm rounded-4 {% if id_editar %}border border-primary{% endif %}">
        <div class="card-header bg-white border-0 pt-4 px-4 px-md-5 d-flex justify-content-between align-items-center">
            
            {% if id_editar %}
                <div class="text-primary">
                    <h4 class="fw-bold mb-0"><i class="bi bi-pencil-fill me-2"></i>Editando: {{ funcionario_editando.nome_completo }}</h4>
                    <small class="text-muted">Altere os dados abaixo e clique em Salvar</small>
                </div>
                <a href="{% url 'cadastro_funcionarios' %}" class="btn btn-sm btn-outline-danger">Cancelar Edição</a>
            {% else %}
                <h4 class="text-primary fw-bold mb-0"><i class="bi bi-person-plus-fill me-2"></i>Novo Cadastro</h4>
            {% endif %}
            
        </div>
        
        <div class="card-body p-4 p-md-5">
            <form method="post">
                {% csrf_token %}
                
                <h5 class="text-secondary fw-bold mb-3 small text-uppercase ls-1">Dados Pessoais</h5>
                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Nome Completo</label>
                        {{ form.nome_completo }}
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">CPF</label>
                        {{ form.cpf }}
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Data de Nascimento</label>
                        <input type="date" name="data_nascimento" class="form-control" 
                               value="{{ form.data_nascimento.value|date:'Y-m-d'|default:'' }}" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">E-mail</label>
                        {{ form.email }}
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Telefone</label>
                        {{ form.telefone }}
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Estado Civil</label>
                        {{ form.estado_civil }}
                    </div>
                </div>

                <hr class="text-muted opacity-25">

                <h5 class="text-secondary fw-bold mb-3 mt-4 small text-uppercase ls-1">Dados Contratuais</h5>
                <div class="row g-3 mb-4">
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Cargo</label>
                        {{ form.cargo }}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Departamento</label>
                        {{ form.departamento }}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Data de Admissão</label>
                        <input type="date" name="data_admissao" class="form-control" 
                               value="{{ form.data_admissao.value|date:'Y-m-d'|default:'' }}" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Salário (R$)</label>
                        {{ form.salario }}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Tipo de Contrato</label>
                        {{ form.tipo_contrato }}
                    </div>
                </div>

                <hr class="text-muted opacity-25">
                <h5 class="text-danger fw-bold mb-3 mt-4 small text-uppercase ls-1">Área de Desligamento</h5>
                <div class="row g-3 mb-4 bg-danger bg-opacity-10 p-3 rounded align-items-center">
                    <div class="col-md-5">
                        <div class="form-check form-switch">
                            {{ form.desligado }}
                            <label class="form-check-label fw-bold" for="id_desligado">Colaborador desligado?</label>
                        </div>
                    </div>
                    <div class="col-md-4" id="div_data_desligamento" style="display: none;">
                        <label class="form-label fw-bold text-danger">Data do Desligamento</label>
                        <input type="date" name="data_desligamento" id="id_data_desligamento" class="form-control"
                               value="{{ form.data_desligamento.value|date:'Y-m-d'|default:'' }}">
                    </div>
                </div>

                <hr class="text-muted opacity-25">

                <h5 class="text-secondary fw-bold mb-3 mt-4 small text-uppercase ls-1">Endereço</h5>
                <div class="row g-3 mb-4">
                    <div class="col-md-2">
                        <label class="form-label fw-bold">CEP</label>
                        <input type="text" name="cep" id="id_cep" class="form-control" 
                               value="{{ form.cep.value|default:'' }}" placeholder="00000-000" maxlength="9">
                    </div>
                    <div class="col-md-8">
                        <label class="form-label fw-bold">Logradouro</label>
                        <input type="text" name="logradouro" id="id_logradouro" class="form-control"
                               value="{{ form.logradouro.value|default:'' }}">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold">Número</label>
                        <input type="text" name="numero" id="id_numero" class="form-control"
                               value="{{ form.numero.value|default:'' }}">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Bairro</label>
                        <input type="text" name="bairro" id="id_bairro" class="form-control"
                               value="{{ form.bairro.value|default:'' }}">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Cidade</label>
                        <input type="text" name="cidade" id="id_cidade" class="form-control"
                               value="{{ form.cidade.value|default:'' }}">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Estado (UF)</label>
                        {{ form.uf }}
                    </div>
                </div>

                <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-5">
                    <button type="submit" class="btn {% if id_editar %}btn-warning text-dark{% else %}btn-success{% endif %} px-5 rounded-pill fw-bold">
                        <i class="bi {% if id_editar %}bi-save{% else %}bi-check-lg{% endif %} me-2"></i> 
                        {% if id_editar %}Salvar Alterações{% else %}Salvar Cadastro{% endif %}
                    </button>
                </div>

            </form>
        </div>
    </div>
    
    {% if id_editar and historico %}
    <div class="card border-0 shadow-sm rounded-4 mt-5">
        <div class="card-header bg-secondary bg-opacity-10 border-0 pt-4 px-4">
            <h5 class="fw-bold mb-0"><i class="bi bi-clock-history me-2"></i>Histórico de Alterações</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped mb-0">
                    <thead>
                        <tr>
                            <th class="px-4">Data/Hora</th>
                            <th>Usuário</th>
                            <th>Ação</th>
                            <th>Detalhes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in historico %}
                        <tr>
                            <td class="px-4">{{ log.action_time|date:"d/m/Y H:i" }}</td>
                            <td>{{ log.user.username }}</td>
                            <td>
                                {% if log.action_flag == 1 %}Criado{% elif log.action_flag == 2 %}Editado{% else %}Apagado{% endif %}
                            </td>
                            <td class="text-muted">{{ log.change_message }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        // --- 1. Lógica do Checkbox de Desligamento ---
        const checkDesligado = document.getElementById('id_desligado');
        const divDataDesligamento = document.getElementById('div_data_desligamento');
        const inputDataDesligamento = document.getElementById('id_data_desligamento');

        function toggleDesligamento() {
            if (checkDesligado && checkDesligado.checked) {
                divDataDesligamento.style.display = 'block';
                inputDataDesligamento.required = true; // Torna a data obrigatória se marcado
            } else if (checkDesligado) {
                divDataDesligamento.style.display = 'none';
                inputDataDesligamento.value = ''; // Limpa a data
                inputDataDesligamento.required = false;
            }
        }

        // Executa ao carregar (para ver se já veio marcado do banco)
        toggleDesligamento();

        // Executa ao clicar
        if (checkDesligado) {
            checkDesligado.addEventListener('change', toggleDesligamento);
        }


        // --- 2. Lógica do CEP Automático ---
        const cepInput = document.getElementById('id_cep');
        
        if (cepInput) {
            cepInput.addEventListener('blur', function() {
                let cep = this.value.replace(/\D/g, '');
                
                if (cep.length === 8) {
                    // Feedback visual
                    if(document.getElementById('id_logradouro')) document.getElementById('id_logradouro').placeholder = "Buscando...";

                    fetch(`https://viacep.com.br/ws/${cep}/json/`)
                        .then(response => response.json())
                        .then(data => {
                            if (!data.erro) {
                                if(document.getElementById('id_logradouro')) document.getElementById('id_logradouro').value = data.logradouro;
                                if(document.getElementById('id_bairro')) document.getElementById('id_bairro').value = data.bairro;
                                if(document.getElementById('id_cidade')) document.getElementById('id_cidade').value = data.localidade;
                                
                                // Tenta selecionar o estado no Dropdown
                                const ufSelect = document.getElementById('id_uf');
                                if(ufSelect) ufSelect.value = data.uf;

                                document.getElementById('id_numero').focus();
                            } else {
                                alert("CEP não encontrado.");
                                if(document.getElementById('id_logradouro')) document.getElementById('id_logradouro').placeholder = "";
                            }
                        })
                        .catch(error => console.error('Erro:', error));
                }
            });
        }
    });
</script>

<style>
    /* Estilo global para inputs gerados pelo Django ficarem padronizados */
    input[type="text"], input[type="email"], input[type="number"], input[type="tel"], select, input[type="date"] {
        display: block;
        width: 100%;
        padding: 0.375rem 0.75rem;
        font-size: 1rem;
        color: #212529;
        background-color: #fff;
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
    }
    
    /* Ajuste específico para o Switch do Bootstrap */
    .form-check-input {
        width: 3em; 
        height: 1.5em; 
        margin-right: 10px;
        cursor: pointer;
    }
</style>
{% endblock %}